{% extends 'turnos/base.html' %}
{% block title %}Panel de Gesti√≥n{% endblock %}

{% block content %} 

    <div style="display: flex; justify-content: space-between; margin-bottom: 25px;">
        
        <div class="card" style="flex: 1; margin-right: 15px; border-left: 5px solid #007bff;">
            <h3>{{ saludo }}, {{ nombre_usuario }}</h3>
            <p style="font-size: 1.2em; margin: 5px 0; font-weight: bold;">
                {{ hora_actual|date:"H:i, " }} {{ hora_actual|date:"j" }} de {{ hora_actual|date:"F" }} de {{ hora_actual|date:"Y" }}
            </p>

            {% if user.is_authenticated %}
                <div style="margin-top: 15px; display: flex; align-items: center; justify-content: space-between;">
                    
                    <span class="estado-{{ estado_operador.clase }}">
                        {{ estado_operador.mensaje|safe }}
                    </span>

                    {% if estado_operador.mostrar_boton %}
                        <a href="{% url 'registrar_asistencia_logueado' %}" 
                           style="display: inline-block; padding: 10px 18px; 
                                  background-color: #007bff; color: white; 
                                  text-decoration: none; border-radius: 4px; font-weight: bold;">
                            Registrar Llegada
                        </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
        
        <div class="card" style="flex: 1; margin-right: 15px; border-left: 5px solid #cc0000;">
            <h3>Pr√≥ximo Turno Programado</h3>
            {% if siguiente_turno %}
                <p style="font-size: 1.2em; margin: 5px 0;">
                    <strong>Tipo:</strong> {{ siguiente_turno.ID_turno.Tipo_turno }}
                </p>
                <p style="font-size: 1em; margin: 0;">
                    <strong>Comienza a las:</strong> {{ siguiente_turno.ID_turno.Hora_inicio|time:"H:i" }} 
                    (Asignado a: <a href="{% url 'detalle_personal' rut=siguiente_turno.Rut.Rut %}">{{ siguiente_turno.Rut.Apellido }}</a>)
                </p>
            {% else %}
                <p style="font-size: 1em; color: #999;">No hay turnos programados pendientes para hoy.</p>
            {% endif %}
        </div>

        {% if user.is_superuser or perms.turnos.view_solicitudcambio %}
            <div class="card" style="flex: 1; border-left: 5px solid orange;">
                <h3>üîî Solicitudes Pendientes</h3>
                {% if solicitudes_pendientes > 0 %}
                    <p style="font-size: 1.2em; margin: 5px 0; color: red; font-weight: bold;">
                        Tienes {{ solicitudes_pendientes }} PENDIENTES DE REVISI√ìN
                    </p>
                    <p style="margin: 0;">
                        <a href="{% url 'gestionar_solicitudes' %}" style="color: blue; text-decoration: none;">
                            ‚Üí Ir a Gesti√≥n de Solicitudes
                        </a>
                    </p>
                {% else %}
                    <p style="font-size: 1.2em; margin: 5px 0; color: green;">
                        No hay solicitudes pendientes.
                    </p>
                {% endif %}
            </div>
        {% endif %}

    </div>
    
    <div class="card">
        <h3>Turnos Programados para Hoy ({{ fecha_hoy|date:"d M Y" }} - {{ registros_hoy|length }} registros)</h3>
        {% if registros_hoy %}
            <table>
                <thead>
                    <tr>
                        <th>Hora Inicio</th>
                        <th>Hora Fin</th>
                        <th>Tipo de Turno</th>
                        <th>Funcionario</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for registro in registros_hoy %}
                    <tr>
                        <td>{{ registro.ID_turno.Hora_inicio|time:"H:i" }}</td>
                        <td>{{ registro.ID_turno.Hora_fin|time:"H:i" }}</td>
                        <td>{{ registro.ID_turno.Tipo_turno }}</td>
                        <td>
                            <a href="{% url 'detalle_personal' rut=registro.Rut.Rut %}">
                                {{ registro.Rut.Nombre }} {{ registro.Rut.Apellido }}
                            </a>
                        </td>
                        <td>
                            <span style="font-weight: bold; color: 
                                {% if registro.ID_estado.ID_estado == 1 %}green
                                {% elif registro.ID_estado.ID_estado == 2 %}orange
                                {% else %}gray
                                {% endif %};">
                                {{ registro.ID_estado.Nombre_estado }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="color: #999;">No hay turnos registrados para el d√≠a de hoy.</p>
        {% endif %}
    </div>

    <div class="card" style="margin-top: 25px;">
        <h3>Personal Registrado en el Sistema ({{ personal|length }} personas)</h3>
        <table>
            <thead>
                <tr>
                    <th>Nombre Completo</th>
                    <th>RUT</th>
                    <th>Cargo</th>
                    <th>√Årea</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for p in personal %}
                <tr>
                    <td>{{ p.Nombre }} {{ p.Apellido }}</td>
                    <td>{{ p.Rut }}</td>
                    <td>{{ p.ID_cargo.Nombre_cargo }}</td>
                    <td>{{ p.ID_area.Nombre_area }}</td>
                    <td>
                        <a href="{% url 'detalle_personal' rut=p.Rut %}" style="text-decoration: none; color: #007bff;">Ver Detalle</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

{% endblock content %}